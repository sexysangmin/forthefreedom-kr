name: YAML to HTML Sync - ììœ ì™€í˜ì‹  CMS ì‹œìŠ¤í…œ

on:
  push:
    branches: [ main ]
    paths:
      - 'content/**/*.yml'
      - 'content/**/*.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - 'content/**/*.yml'
      - 'content/**/*.yaml'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  detect-changes:
    name: ë³€ê²½ëœ YAML íŒŒì¼ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      yaml-files: ${{ steps.changed-files.outputs.all_changed_files }}
      has-changes: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ë³€ê²½ëœ YAML íŒŒì¼ ê°ì§€
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            content/**/*.yml
            content/**/*.yaml

  validate-yaml:
    name: YAML êµ¬ë¬¸ ê²€ì¦
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: PyYAML ì„¤ì¹˜
        run: pip install PyYAML

      - name: YAML íŒŒì¼ ê²€ì¦
        run: |
          echo "ğŸ” YAML íŒŒì¼ êµ¬ë¬¸ ê²€ì¦ ì‹œì‘..."
          
          validation_failed=0
          
          for file in ${{ needs.detect-changes.outputs.yaml-files }}; do
            if [ -f "$file" ]; then
              echo "âœ… ê²€ì¦ ì¤‘: $file"
              python -c "
          import yaml
          import sys
          try:
              with open('$file', 'r', encoding='utf-8') as f:
                  yaml.safe_load(f)
              print('âœ… $file: ìœ íš¨í•œ YAML')
          except yaml.YAMLError as e:
              print('âŒ $file: YAML êµ¬ë¬¸ ì˜¤ë¥˜')
              print(f'ì˜¤ë¥˜ ë‚´ìš©: {e}')
              sys.exit(1)
          except Exception as e:
              print('âŒ $file: íŒŒì¼ ì½ê¸° ì˜¤ë¥˜')
              print(f'ì˜¤ë¥˜ ë‚´ìš©: {e}')
              sys.exit(1)
              " || validation_failed=1
            fi
          done
          
          if [ $validation_failed -eq 1 ]; then
            echo "âŒ YAML ê²€ì¦ ì‹¤íŒ¨!"
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  YAML íŒŒì¼ ê²€ì¦ ì™„ë£Œ!"

  convert-to-html:
    name: YAML â†’ HTML ë³€í™˜
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-yaml]
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        include:
          # ë©”ì¸ í˜ì´ì§€
          - yaml: content/index.yml
            html: index.html
            template: templates/index.template.html
          
          # ì†Œê°œ í˜ì´ì§€ë“¤
          - yaml: content/about.yml
            html: about.html
            template: templates/about.template.html
          - yaml: content/about/founding.yml
            html: about/founding.html
            template: templates/about/founding.template.html
          - yaml: content/about/location.yml
            html: about/location.html
            template: templates/about/location.template.html
          - yaml: content/about/organization.yml
            html: about/organization.html
            template: templates/about/organization.template.html
          - yaml: content/about/people.yml
            html: about/people.html
            template: templates/about/people.template.html
          - yaml: content/about/principles.yml
            html: about/principles.html
            template: templates/about/principles.template.html
          - yaml: content/about/schedule.yml
            html: about/schedule.html
            template: templates/about/schedule.template.html
          
          # FAQ & ë‹¹ì›
          - yaml: content/faq.yml
            html: faq.html
            template: templates/faq.template.html
          - yaml: content/members.yml
            html: members.html
            template: templates/members.template.html
          - yaml: content/members/join.yml
            html: members/join.html
            template: templates/members/join.template.html
          - yaml: content/members/dues.yml
            html: members/dues.html
            template: templates/members/dues.template.html
          
          # ë‰´ìŠ¤
          - yaml: content/news.yml
            html: news.html
            template: templates/news.template.html
          - yaml: content/news/activities.yml
            html: news/activities.html
            template: templates/news/activities.template.html
          - yaml: content/news/events.yml
            html: news/events.html
            template: templates/news/events.template.html
          - yaml: content/news/gallery.yml
            html: news/gallery.html
            template: templates/news/gallery.template.html
          - yaml: content/news/media.yml
            html: news/media.html
            template: templates/news/media.template.html
          - yaml: content/news/press.yml
            html: news/press.html
            template: templates/news/press.template.html
          
          # ê³µì§€ì‚¬í•­
          - yaml: content/notices.yml
            html: notices.html
            template: templates/notices.template.html
          - yaml: content/notice-1.yml
            html: notice-1.html
            template: templates/notice-detail.template.html
          - yaml: content/notice-2.yml
            html: notice-2.html
            template: templates/notice-detail.template.html
          
          # ì •ì±…
          - yaml: content/policy.yml
            html: policy.html
            template: templates/policy.template.html
          - yaml: content/policy/economy.yml
            html: policy/economy.html
            template: templates/policy/economy.template.html
          - yaml: content/policy/education.yml
            html: policy/education.html
            template: templates/policy/education.template.html
          - yaml: content/policy/security.yml
            html: policy/security.html
            template: templates/policy/security.template.html
          
          # ìë£Œì‹¤ & í›„ì›
          - yaml: content/resources.yml
            html: resources.html
            template: templates/resources.template.html
          - yaml: content/support.yml
            html: support.html
            template: templates/support.template.html

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          pip install PyYAML Jinja2 beautifulsoup4 lxml

      - name: YAML â†’ HTML ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ”„ ë³€í™˜ ì‹œì‘: ${{ matrix.yaml }} â†’ ${{ matrix.html }}"
          
          # YAML íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ ! -f "${{ matrix.yaml }}" ]; then
            echo "âš ï¸ YAML íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: ${{ matrix.yaml }}"
            exit 0
          fi
          
          # ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/yaml-to-html-converter.py \
            --yaml "${{ matrix.yaml }}" \
            --template "${{ matrix.template }}" \
            --output "${{ matrix.html }}" \
            --validate
          
          echo "âœ… ë³€í™˜ ì™„ë£Œ: ${{ matrix.html }}"

      - name: ë³€í™˜ëœ HTML íŒŒì¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: converted-html-${{ github.run_id }}
          path: ${{ matrix.html }}
          retention-days: 30

  deploy-to-netlify:
    name: Netlify ë°°í¬
    runs-on: ubuntu-latest
    needs: convert-to-html
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ë³€í™˜ëœ HTML íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: converted-html-${{ github.run_id }}
          path: ./

      - name: Netlify CLI ì„¤ì¹˜
        run: npm install -g netlify-cli

      - name: Netlify ë°°í¬
        run: |
          echo "ğŸš€ Netlify ë°°í¬ ì‹œì‘..."
          netlify deploy \
            --prod \
            --dir . \
            --site ${{ secrets.NETLIFY_SITE_ID }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }}
          echo "âœ… Netlify ë°°í¬ ì™„ë£Œ!"

  backup-system:
    name: ë°±ì—… ì‹œìŠ¤í…œ
    runs-on: ubuntu-latest
    needs: convert-to-html
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: í˜„ì¬ ë‚ ì§œ ì„¤ì •
        id: date
        run: echo "date=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_OUTPUT

      - name: ë°±ì—… ìƒì„±
        run: |
          echo "ğŸ“¦ ë°±ì—… ìƒì„± ì¤‘..."
          
          # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p backups/${{ steps.date.outputs.date }}
          
          # YAML íŒŒì¼ë“¤ ë°±ì—…
          cp -r content/ backups/${{ steps.date.outputs.date }}/
          
          # ë°±ì—… ì••ì¶•
          tar -czf backups/backup-${{ steps.date.outputs.date }}.tar.gz \
            backups/${{ steps.date.outputs.date }}/
          
          echo "âœ… ë°±ì—… ì™„ë£Œ: backup-${{ steps.date.outputs.date }}.tar.gz"

      - name: ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: backup-${{ steps.date.outputs.date }}
          path: backups/backup-${{ steps.date.outputs.date }}.tar.gz
          retention-days: 90

  notification:
    name: ì•Œë¦¼ ì „ì†¡
    runs-on: ubuntu-latest
    needs: [convert-to-html, deploy-to-netlify, backup-system]
    if: always()
    steps:
      - name: ì„±ê³µ ì•Œë¦¼
        if: needs.convert-to-html.result == 'success' && needs.deploy-to-netlify.result == 'success'
        run: |
          echo "âœ… CMS ë™ê¸°í™” ì„±ê³µ!"
          echo "ğŸ“Š ë³€í™˜ëœ íŒŒì¼ ìˆ˜: ${{ strategy.job-total }}"
          echo "ğŸŒ ë°°í¬ ìƒíƒœ: ì„±ê³µ"
          echo "ğŸ“¦ ë°±ì—… ìƒíƒœ: ì™„ë£Œ"

      - name: ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ CMS ë™ê¸°í™” ì‹¤íŒ¨!"
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
          echo "ğŸ“§ ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."

  cleanup:
    name: ì •ë¦¬ ì‘ì—…
    runs-on: ubuntu-latest
    needs: [convert-to-html, deploy-to-netlify, backup-system]
    if: always()
    steps:
      - name: ì„ì‹œ íŒŒì¼ ì •ë¦¬
        run: |
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
          # 30ì¼ ì´ìƒ ëœ ë°±ì—… íŒŒì¼ ì‚­ì œ (í•„ìš”ì‹œ)
          echo "âœ… ì •ë¦¬ ì™„ë£Œ" 