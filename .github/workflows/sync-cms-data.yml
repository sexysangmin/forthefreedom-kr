name: Sync CMS Data to HTML

on:
  push:
    paths:
      - 'content/homepage.yml'
      - 'content/**'

permissions:
  contents: write
  actions: read

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Sync homepage data to index.html
        run: |
          if [ -f "content/homepage.yml" ]; then
            echo "ğŸ”„ Syncing homepage data to index.html..."
            
            # YAMLì—ì„œ ë°ì´í„° ì¶”ì¶œ
            HERO_TITLE=$(yq e '.hero.title' content/homepage.yml)
            HERO_SUBTITLE=$(yq e '.hero.subtitle' content/homepage.yml)
            HERO_DESCRIPTION=$(yq e '.hero.description' content/homepage.yml)
            HERO_CTA_TEXT=$(yq e '.hero.cta_text' content/homepage.yml)
            HERO_CTA_LINK=$(yq e '.hero.cta_link' content/homepage.yml)
            
            REP_NAME=$(yq e '.representative.name' content/homepage.yml)
            REP_POSITION=$(yq e '.representative.position' content/homepage.yml)
            REP_MSG1=$(yq e '.representative.messages[0]' content/homepage.yml)
            REP_MSG2=$(yq e '.representative.messages[1]' content/homepage.yml)
            REP_MSG3=$(yq e '.representative.messages[2]' content/homepage.yml)
            
            POLICY_TITLE=$(yq e '.policies.title' content/homepage.yml)
            POLICY_SUBTITLE=$(yq e '.policies.subtitle' content/homepage.yml)
            
            echo "ğŸ“ Extracted data:"
            echo "Hero Title: $HERO_TITLE"
            echo "Hero Subtitle: $HERO_SUBTITLE"
            echo "Representative: $REP_NAME"
            
            # íˆì–´ë¡œ ì„¹ì…˜ ì—…ë°ì´íŠ¸ (ë³µì¡í•œ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ êµ¬ì¡° ìœ ì§€)
            # ì œëª© ì—…ë°ì´íŠ¸ (ììœ ì™€í˜ì‹  + ë¶€ì œëª©)
            sed -i "s|<span style=\"font-weight: 700;\">ììœ </span><span style=\"font-weight: 200;\">ì™€</span><span style=\"font-weight: 700;\">í˜ì‹ </span><br>ìƒˆë¡œìš´ ì •ì¹˜ë¥¼ í•¨ê»˜|<span style=\"font-weight: 700;\">${HERO_TITLE%ì™€*}</span><span style=\"font-weight: 200;\">ì™€</span><span style=\"font-weight: 700;\">${HERO_TITLE#*ì™€}</span><br>${HERO_SUBTITLE}|g" index.html
            
            # íˆì–´ë¡œ ì„¤ëª… ì—…ë°ì´íŠ¸
            sed -i "s|êµ­ë¯¼ê³¼ í•¨ê»˜ ë” ë‚˜ì€ ëŒ€í•œë¯¼êµ­ì„ ë§Œë“¤ì–´ê°ˆ ììœ ì™€í˜ì‹ ì— ì°¸ì—¬í•˜ì„¸ìš”|${HERO_DESCRIPTION}|g" index.html
            
            # CTA ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            sed -i "s|ë‹¹ì› ê°€ì…í•˜ê¸°|${HERO_CTA_TEXT}|g" index.html
            
            # CTA ë§í¬ ì—…ë°ì´íŠ¸
            sed -i "s|href=\"https://www.ihappynanum.com/Nanum/api/screen/F7FCRIO2E3\"|href=\"${HERO_CTA_LINK}\"|g" index.html
            
            # ëŒ€í‘œ ì¸ì‚¬ë§ ì„¹ì…˜ ì—…ë°ì´íŠ¸
            sed -i "s|\"ì•ˆë…•í•˜ì„¸ìš”. ììœ ì™€í˜ì‹  ë‹¹ ëŒ€í‘œì…ë‹ˆë‹¤.\"|\"${REP_MSG1}\"|g" index.html
            sed -i "s|ìš°ë¦¬ëŠ” ììœ ì™€ í˜ì‹ ì´ë¼ëŠ” ê°€ì¹˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€í•œë¯¼êµ­ ë¯¸ë˜ë¥¼ ì—´ì–´ê°€ê³ ì í•©ë‹ˆë‹¤. ê¸°ì¡´ ì •ì¹˜ì˜ í‹€ì„ ë²—ì–´ë‚˜ ì§„ì •ìœ¼ë¡œ êµ­ë¯¼ì„ ìœ„í•œ ì •ì¹˜ë¥¼ êµ¬í˜„í•˜ê² ìŠµë‹ˆë‹¤.|${REP_MSG2}|g" index.html
            sed -i "s|ê²½ì œ ì„±ì¥ê³¼ ì‚¬íšŒ í†µí•©, ê·¸ë¦¬ê³  ì§€ì†ê°€ëŠ¥í•œ ë°œì „ì„ ìœ„í•´ ëª¨ë“  êµ­ë¯¼ì´ í–‰ë³µí•œ ë‚˜ë¼ë¥¼ ë§Œë“¤ì–´ê°€ê² ìŠµë‹ˆë‹¤.|${REP_MSG3}|g" index.html
            
            # ëŒ€í‘œ ì´ë¦„ ì—…ë°ì´íŠ¸
            sed -i "s|ê¹€â—‹â—‹|${REP_NAME}|g" index.html
            sed -i "s|ììœ ì™€í˜ì‹  ë‹¹ ëŒ€í‘œ|${REP_POSITION}|g" index.html
            
            # ì •ì±… ì„¹ì…˜ ì œëª© ì—…ë°ì´íŠ¸
            sed -i "s|7ëŒ€ í•µì‹¬ ì •ì±…ìœ¼ë¡œ<br>.*ë¯¸ë˜ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤.*</span>|${POLICY_TITLE//ë¯¸ë˜ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤/<br><span class=\"text-red-600\">ë¯¸ë˜ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤</span>}|g" index.html
            sed -i "s|êµ­ë¯¼ìƒí™œì„ ê°œì„ í•˜ê³  êµ­ê°€ ë°œì „ì„ ì´ëŒì–´ê°ˆ í•µì‹¬ ì •ì±…ë“¤ì„ ì†Œê°œí•©ë‹ˆë‹¤|${POLICY_SUBTITLE}|g" index.html
            
            echo "âœ… Homepage data synchronized successfully!"
          else
            echo "âŒ homepage.yml not found!"
            exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add index.html
            git commit -m "ğŸ”„ CMS ë™ê¸°í™”: homepage.yml ë³€ê²½ì‚¬í•­ì„ index.htmlì— ìë™ ì ìš©"
            git push
            echo "âœ… Changes committed and pushed successfully!"
          fi 